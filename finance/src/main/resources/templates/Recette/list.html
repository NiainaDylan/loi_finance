<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Financier des Recettes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        h1 { color: #333; text-align: center; }
        .controls { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px; align-items:center; }
        .controls select, .controls input { padding:6px; }
        .table-wrap { overflow-x:auto; }
        table { width: 100%; border-collapse: collapse; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-width: 700px; }
        thead { background-color: #2196F3; color: white; }
        th, td { padding: 8px 12px; text-align: left; border: 1px solid #ddd; }
        th { cursor:pointer; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        tbody tr:hover { background-color: #f1f1f1; }
        .montant { text-align: right; }
        .container { max-width: 1400px; margin: 0 auto; }
        .total-row { background-color: #e3f2fd !important; font-weight: bold; }
        .pagination { margin-top:10px; display:flex; gap:8px; align-items:center; }
        .page-link { padding:6px 8px; background:#eee; text-decoration:none; color:#333; border-radius:4px; }
        .page-link.active { background:#2196F3; color:white; }
        @media (max-width:700px){ .controls{flex-direction:column; align-items:stretch} }
    </style>
</head>
<body>
    <div class="container">
        <h1>Suivi Financier des Recettes</h1>

        <form method="get" class="controls" th:action="@{/suivi-financier-recettes}">
            <label>
                Recette:
                <select name="recetteId">
                    <option value="" th:selected="${recetteId == null}">Toutes</option>
                    <option th:each="r : ${allRecettes}" th:value="${r.idRecette}" th:text="${r.nature}" th:selected="${r.idRecette == recetteId}"></option>
                </select>
            </label>

            <label>
                Nature:
                <select name="natureId">
                    <option value="" th:selected="${natureId == null}">Toutes</option>
                    <option th:each="n : ${allNatures}" th:value="${n.idNature}" th:text="${n.libelle}" th:selected="${n.idNature == natureId}"></option>
                </select>
            </label>

            <label>Années de: <input type="number" name="fromYear" th:value="${fromYear}" placeholder="2024" style="width:100px;" /></label>
            <label>à: <input type="number" name="toYear" th:value="${toYear}" placeholder="2025" style="width:100px;" /></label>

            <label>Taille page:
                <select name="size">
                    <option th:value="10" th:selected="${size==10}">10</option>
                    <option th:value="20" th:selected="${size==20}">20</option>
                    <option th:value="50" th:selected="${size==50}">50</option>
                </select>
            </label>

            <input type="hidden" name="sortField" th:value="${sortField}" />
            <input type="hidden" name="sortDir" th:value="${sortDir}" />

            <button type="submit">Appliquer</button>
            <a class="page-link" th:href="@{/suivi-financier-recettes}">Réinitialiser</a>
        </form>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>
                            <a th:href="@{/suivi-financier-recettes(recetteId=${recetteId}, natureId=${natureId}, fromYear=${fromYear}, toYear=${toYear}, page=0, size=${size}, sortField='recette', sortDir=${sortField=='recette' && sortDir=='asc' ? 'desc' : 'asc'})" th:text="'Recette' + (sortField=='recette' ? (sortDir=='asc' ? ' ▲' : ' ▼') : '')"></a>
                        </th>
                        <th>
                            <a th:href="@{/suivi-financier-recettes(recetteId=${recetteId}, natureId=${natureId}, fromYear=${fromYear}, toYear=${toYear}, page=0, size=${size}, sortField='libelle', sortDir=${sortField=='libelle' && sortDir=='asc' ? 'desc' : 'asc'})" th:text="'Libelle' + (sortField=='libelle' ? (sortDir=='asc' ? ' ▲' : ' ▼') : '')"></a>
                        </th>
                        <th th:each="annee : ${annees}" class="montant" th:text="${annee}"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="nature : ${natures}">
                        <td th:text="${nature.recette != null ? nature.recette.nature : 'N/A'}"></td>
                        <td th:text="${nature.libelle}"></td>
                        <td th:each="annee : ${annees}" class="montant"
                            th:text="${(montantsParNatureAnnee[nature.idNature] != null and montantsParNatureAnnee[nature.idNature][annee] != null) ? #numbers.formatDecimal(montantsParNatureAnnee[nature.idNature][annee],1,'POINT',2,'COMMA') : '0,00'}"></td>
                    </tr>

                    <tr th:if="${#lists.isEmpty(natures)}">
                        <td th:colspan="${2 + #lists.size(annees)}" style="text-align: center; color: #999;">Aucune donnée disponible</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td colspan="2"><strong>TOTAL</strong></td>
                        <td th:each="annee : ${annees}" class="montant" th:text="${totauxParAnnee[annee] != null ? #numbers.formatDecimal(totauxParAnnee[annee],1,'POINT',2,'COMMA') : '0,00'}"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="pagination">
            <span>Page:</span>
            <a class="page-link" th:if="${currentPage>0}" th:href="@{/suivi-financier-recettes(recetteId=${recetteId}, natureId=${natureId}, fromYear=${fromYear}, toYear=${toYear}, page=${currentPage-1}, size=${size}, sortField=${sortField}, sortDir=${sortDir})">Préc</a>
            <span th:each="p : ${#numbers.sequence(0, totalPages-1)}">
                <a class="page-link" th:classappend="${p==currentPage} ? ' active'" th:href="@{/suivi-financier-recettes(recetteId=${recetteId}, natureId=${natureId}, fromYear=${fromYear}, toYear=${toYear}, page=${p}, size=${size}, sortField=${sortField}, sortDir=${sortDir})" th:text="${p+1}"></a>
            </span>
            <a class="page-link" th:if="${currentPage<totalPages-1}" th:href="@{/suivi-financier-recettes(recetteId=${recetteId}, natureId=${natureId}, fromYear=${fromYear}, toYear=${toYear}, page=${currentPage+1}, size=${size}, sortField=${sortField}, sortDir=${sortDir})">Suiv</a>
            <span th:text="${totalItems} + ' éléments'"></span>
        </div>

    </div>
</body>
</html>
